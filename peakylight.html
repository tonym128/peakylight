<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>3D Geographical Map with Sun Position</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <link rel="stylesheet" href="peakylight.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/suncalc/1.8.0/suncalc.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
</head>
<body>

    <div id="map-container">
        <canvas id="webgl-canvas"></canvas>
        <div id="map"></div>
    </div>

    <div id="controls">
        <button id="toggle-controls-btn">...</button>
        <h2>Controls</h2>
        <div class="control-group">
            <label for="address-search">Address Search:</label>
            <input type="text" id="address-search" placeholder="e.g. 1600 Pennsylvania Ave, DC">
            <div id="address-results"></div>
        </div>
        <div class="control-group">
            <div class="coord-inputs">
                <div>
                    <label for="lat-input">Latitude:</label>
                    <input type="number" id="lat-input" step="0.0001" min="-90" max="90">
                </div>
                <div>
                    <label for="lon-input">Longitude:</label>
                    <input type="number" id="lon-input" step="0.0001" min="-180" max="180">
                </div>
            </div>
            <button id="update-coords-btn" style="margin-top: 10px;">Set Location</button>
        </div>
        <div class="control-group">
            <button id="locate-btn">Use My Location</button>
        </div>
        <div class="control-group">
            <button id="select-location-btn">Select Location on Map</button>
        </div>
        <div class="control-group">
            <label for="map-layer-picker">Map Layer:</label>
            <select id="map-layer-picker">
                <option value="opentopo">OpenTopoMap</option>
                <option value="osm">OpenStreetMap</option>
                <option value="satellite">World Imagery</option>
            </select>
        </div>
        <div class="control-group">
            <label class="checkbox-label">
                <input type="checkbox" id="cloud-cover-toggle" checked>
                Show Cloud Cover
            </label>
        </div>
        <div class="control-group">
            <label for="terrain-detail-picker">Terrain Detail:</label>
            <select id="terrain-detail-picker">
                <option value="12">Low</option>
                <option value="13" selected>Medium</option>
                <option value="14">High</option>
                <option value="15">Ultra</option>
            </select>
        </div>
        <div class="control-group">
            <label for="timezone-picker">Timezone:</label>
            <select id="timezone-picker"></select>
        </div>
        <div class="control-group">
            <label for="date-picker">Date:</label>
            <input type="date" id="date-picker">
            <input type="range" id="date-slider" min="1" max="365" step="1" style="margin-top: 5px;">
        </div>
        <div class="control-group">
            <label for="time-slider">Time of Day:</label>
            <div class="time-slider-container">
                <input type="range" id="time-slider" min="0" max="1439" step="1">
                <div id="sunrise-indicator" class="time-indicator" title="Sunrise"></div>
                <div id="sunset-indicator" class="time-indicator" title="Sunset"></div>
            </div>
            <input type="time" id="time-picker" readonly style="margin-top: 5px;">
        </div>
        <div class="control-group">
            <button id="open-solar-btn">‚òÄÔ∏è Solar System Recommendation</button>
        </div>
        <div class="control-group">
            <button id="generate-report-btn">Generate Monthly Report</button>
        </div>
        <div class="control-group">
            <button id="export-split-btn">Export Split-Screen Video</button>
        </div>
        <div id="info-display">
            <p><strong>Location     :</strong> <span id="location-coords">N/A</span></p>
            <p><strong>Astro Sunrise:</strong> <span id="sunrise-time">N/A</span><span class="time-jump-icon" id="jump-to-sunrise" title="Jump to this time">üï∞Ô∏è</span></p>
            <p><strong>Topo Sunrise :</strong> <span id="topo-sunrise-time">N/A</span><span class="time-jump-icon" id="jump-to-topo-sunrise" title="Jump to this time">üï∞Ô∏è</span></p>
            <p style="padding-left: 1em; font-style: italic;">‚îî Daylight Lost: <span id="sunrise-loss">N/A</span></p>
            <p><strong>Astro Sunset :</strong> <span id="sunset-time">N/A</span><span class="time-jump-icon" id="jump-to-sunset" title="Jump to this time">üï∞Ô∏è</span></p>
            <p><strong>Topo Sunset  :</strong> <span id="topo-sunset-time">N/A</span><span class="time-jump-icon" id="jump-to-topo-sunset" title="Jump to this time">üï∞Ô∏è</span></p>
            <p style="padding-left: 1em; font-style: italic;">‚îî Daylight Lost: <span id="sunset-loss">N/A</span></p>
            <p><strong>Total Daylight Lost:</strong> <span id="total-daylight-loss">N/A</span></p>
            <p><strong>Cloud Cover       :</strong> <span id="cloud-cover-display">N/A</span></p>
        </div>
    </div>
    
    <div id="loader">
        <p id="loader-text"></p>
        <div id="progress-bar-container">
            <div id="progress-bar"></div>
        </div>
    </div>

    <div id="compass">
        <svg id="compass-needle" viewBox="0 0 100 100">
            <polygon points="50,0 65,50 50,100 35,50" fill="#E53E3E"/>
            <polygon points="50,0 65,50 50,100 35,50" fill="transparent" stroke="#FFF" stroke-width="5"/>
            <circle cx="50" cy="50" r="10" fill="#FFF"/>
        </svg>
    </div>

    <div id="report-panel">
        <button id="toggle-report-btn">...</button>
        <h2>Monthly Sunrise/Sunset Report</h2>
        <div id="report-table-container">
            <p>Generating report... This may take a moment.</p>
        </div>
        <button id="export-report-btn">Export to PDF</button>
    </div>

    <div id="solar-panel">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h2 style="margin: 0;">Solar System Recommendation</h2>
            <button id="close-solar-btn" style="background: none; border: none; font-size: 24px; cursor: pointer; padding: 0; color: #333;">√ó</button>
        </div>
        <div id="solar-content">
            <div class="solar-input-group">
                <label for="daily-kwh">Daily Power Requirement (kWh):</label>
                <input type="number" id="daily-kwh" min="5" max="100" step="1" value="20" placeholder="e.g., 20">
            </div>
            <div class="solar-input-group">
                <label for="offgrid-percent">Off-Grid Percentage (%):</label>
                <input type="number" id="offgrid-percent" min="0" max="100" step="5" value="80" placeholder="e.g., 80">
            </div>
            <div class="solar-input-group">
                <label for="effective-sun-hours-override">Effective Sun Hours (Override) <span style="font-size: 0.85em; color: #999;">[optional]</span>:</label>
                <input type="number" id="effective-sun-hours-override" min="0.5" max="12" step="0.5" placeholder="Leave blank to use calculated value">
                <small style="color: #666; display: block; margin-top: 5px;" id="sun-hours-info"></small>
            </div>
            <button id="calculate-solar-btn">Calculate Recommendations</button>
            <div id="solar-results" style="margin-top: 20px;"></div>
        </div>
    </div>

    <script src="data.js"></script>
    <script src="mapping.js" defer></script>
    <script src="peakylight.js" defer></script>
</html>
